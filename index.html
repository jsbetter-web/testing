<!DOCTYPE html>
<html>
<head>
    <title>Kart Clone - Multiplayer</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #111; color: white; font-family: sans-serif; overflow: hidden; }
        #ui { position: absolute; top: 10px; width: 100%; z-index: 10; text-align: center; pointer-events: none; }
        #setup { pointer-events: auto; background: rgba(0,0,0,0.9); padding: 20px; display: inline-block; border: 2px solid #555; border-radius: 10px; }
        input { padding: 10px; width: 200px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; }
        button { padding: 10px 20px; cursor: pointer; background: #27ae60; color: white; border: none; font-weight: bold; border-radius: 5px; }
        #status { color: #f1c40f; font-weight: bold; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="setup">
            <h2 style="margin-top:0">KART RACER</h2>
            <button onclick="hostGame()">CREATE ROOM</button>
            <div style="margin: 10px 0;">-- OR --</div>
            <input type="text" id="joinId" placeholder="Friend's Code">
            <button onclick="joinGame()">JOIN</button>
            <div id="status">Connecting to server...</div>
        </div>
    </div>

    <script>
    let peer, conn;
    let player, otherPlayer, boosts;
    let cursors;
    let speed = 0;
    let maxSpeed = 400;
    const driftFactor = 0.94;

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        physics: { default: 'arcade' },
        scene: { preload: preload, create: create, update: update }
    };

    const game = new Phaser.Game(config);

    // Initial server check
    const tempPeer = new Peer();
    tempPeer.on('open', () => { 
        document.getElementById('status').innerText = "Ready to Play!";
        tempPeer.destroy();
    });

    function preload() {
        let g = this.add.graphics();
        // Blue Car
        g.fillStyle(0x3498db); g.fillRect(0, 0, 20, 40);
        g.fillStyle(0x000000); g.fillRect(2, 5, 16, 10);
        g.generateTexture('car_me', 20, 40);
        // Red Car
        g.clear(); g.fillStyle(0xe74c3c); g.fillRect(0, 0, 20, 40);
        g.generateTexture('car_them', 20, 40);
        // Boost Pad
        g.clear(); g.fillStyle(0xf1c40f); g.fillRect(0, 0, 40, 40);
        g.generateTexture('boost', 40, 40);
    }

    function create() {
        this.cameras.main.setBounds(0, 0, 4000, 4000);
        this.physics.world.setBounds(0, 0, 4000, 4000);

        // Simple Track (Grass and Road)
        this.add.rectangle(2000, 2000, 4000, 4000, 0x27ae60);
        let road = this.add.graphics();
        road.lineStyle(120, 0x333333);
        road.strokeRoundedRect(400, 400, 3200, 3200, 600);

        // Boost Pads Group
        boosts = this.physics.add.staticGroup();
        boosts.create(800, 400, 'boost');
        boosts.create(3200, 800, 'boost');
        boosts.create(2000, 3600, 'boost');

        // Players
        player = this.physics.add.sprite(600, 400, 'car_me');
        player.setCollideWorldBounds(true);
        this.cameras.main.startFollow(player, true, 0.1, 0.1);

        otherPlayer = this.add.sprite(-100, -100, 'car_them');

        // Overlap logic for boosts
        this.physics.add.overlap(player, boosts, collectBoost, null, this);

        cursors = this.input.keyboard.createCursorKeys();
    }

    function collectBoost(player, boost) {
        speed = 800; // Instant burst
        document.getElementById('status').innerText = "BOOST!";
        setTimeout(() => { document.getElementById('status').innerText = ""; }, 1000);
    }

    function update() {
        if (cursors.left.isDown) player.setAngularVelocity(-220);
        else if (cursors.right.isDown) player.setAngularVelocity(220);
        else player.setAngularVelocity(0);

        if (cursors.up.isDown) speed = Math.min(speed + 12, maxSpeed);
        else speed *= 0.97;

        const velocityX = Math.sin(player.rotation) * speed;
        const velocityY = -Math.cos(player.rotation) * speed;
        
        player.body.velocity.x = player.body.velocity.x * driftFactor + velocityX * (1 - driftFactor);
        player.body.velocity.y = player.body.velocity.y * driftFactor + velocityY * (1 - driftFactor);

        if (conn && conn.open) {
            conn.send({ x: player.x, y: player.y, angle: player.angle });
        }
    }

    // --- UPDATED NETWORKING ---
    function hostGame() {
        peer = new Peer();
        peer.on('open', id => {
            document.getElementById('status').innerHTML = "CODE: <span style='color:white'>" + id + "</span><br>Send this to your friend!";
        });
        peer.on('connection', c => {
            conn = c;
            setupConn();
        });
    }

    function joinGame() {
        const id = document.getElementById('joinId').value;
        if (!id) return alert("Enter a code first!");
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id);
            setupConn();
        });
    }

    function setupConn() {
        conn.on('open', () => {
            document.getElementById('setup').classList.add('hidden');
            conn.on('data', data => {
                otherPlayer.x = data.x;
                otherPlayer.y = data.y;
                otherPlayer.angle = data.angle;
            });
        });
    }
    </script>
</body>
</html>
