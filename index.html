<!DOCTYPE html>
<html>
<head>
    <title>Multiplayer Drift Racer</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #111; color: white; font-family: 'Courier New', Courier, monospace; overflow: hidden; }
        #ui { position: absolute; top: 10px; width: 100%; z-index: 10; pointer-events: none; }
        #setup { pointer-events: auto; background: rgba(0,0,0,0.8); padding: 20px; display: inline-block; border: 2px solid #555; }
        input { padding: 8px; }
        button { padding: 8px 15px; cursor: pointer; background: #e74c3c; color: white; border: none; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="setup">
            <h2>KART CLONE</h2>
            <button onclick="hostGame()">CREATE ROOM</button>
            <div style="margin: 10px 0;">OR</div>
            <input type="text" id="joinId" placeholder="Paste Code Here">
            <button onclick="joinGame()">JOIN FRIEND</button>
            <p id="status">Status: Offline</p>
        </div>
    </div>

    <script>
    let peer, conn;
    let player, otherPlayer;
    let cursors;
    let speed = 0;
    const maxSpeed = 400;
    const driftFactor = 0.94; // This creates the "sliding" feel

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        physics: { default: 'arcade' },
        scene: { preload: preload, create: create, update: update }
    };

    const game = new Phaser.Game(config);

    function preload() {
        // Draw a simple car
        let g = this.add.graphics();
        g.fillStyle(0x3498db); // Blue Car
        g.fillRect(0, 0, 20, 40);
        g.fillStyle(0x000000); // Windshield
        g.fillRect(2, 5, 16, 10);
        g.generateTexture('car_me', 20, 40);

        g.clear();
        g.fillStyle(0xe74c3c); // Red Car
        g.fillRect(0, 0, 20, 40);
        g.generateTexture('car_them', 20, 40);
    }

    function create() {
        // Create a large world
        this.cameras.main.setBounds(0, 0, 3000, 3000);
        this.physics.world.setBounds(0, 0, 3000, 3000);

        // Draw a simple "Track" background
        let bg = this.add.graphics();
        bg.lineStyle(80, 0x333333);
        bg.strokeRoundedRect(200, 200, 2600, 2600, 500); // The "Road"

        // Local Player
        player = this.physics.add.sprite(400, 300, 'car_me');
        player.setCollideWorldBounds(true);
        this.cameras.main.startFollow(player, true, 0.1, 0.1);

        // Remote Player
        otherPlayer = this.add.sprite(-100, -100, 'car_them');

        cursors = this.input.keyboard.createCursorKeys();
    }

    function update() {
        // 1. TURNING
        if (cursors.left.isDown) {
            player.setAngularVelocity(-200);
        } else if (cursors.right.isDown) {
            player.setAngularVelocity(200);
        } else {
            player.setAngularVelocity(0);
        }

        // 2. ACCELERATION
        if (cursors.up.isDown) {
            speed = Math.min(speed + 10, maxSpeed);
        } else {
            speed *= 0.98; // Natural slowdown
        }

        // 3. DRIFT PHYSICS
        // This is the math that makes it feel like Kart Bros
        const velocityX = Math.sin(player.rotation) * speed;
        const velocityY = -Math.cos(player.rotation) * speed;
        
        // We blend the current velocity with the new direction for a "slide"
        player.body.velocity.x = player.body.velocity.x * driftFactor + velocityX * (1 - driftFactor);
        player.body.velocity.y = player.body.velocity.y * driftFactor + velocityY * (1 - driftFactor);

        // 4. NETWORKING
        if (conn && conn.open) {
            conn.send({
                x: player.x,
                y: player.y,
                angle: player.angle
            });
        }
    }

    // --- NETWORKING LOGIC ---
    function hostGame() {
        peer = new Peer();
        peer.on('open', id => {
            document.getElementById('status').innerText = "SHARE THIS CODE: " + id;
            console.log("My ID:", id);
        });
        peer.on('connection', c => {
            conn = c;
            setupConn();
        });
    }

    function joinGame() {
        const id = document.getElementById('joinId').value;
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id);
            setupConn();
        });
    }

    function setupConn() {
        document.getElementById('setup').classList.add('hidden');
        conn.on('data', data => {
            otherPlayer.x = data.x;
            otherPlayer.y = data.y;
            otherPlayer.angle = data.angle;
        });
    }
    </script>
</body>
</html>
